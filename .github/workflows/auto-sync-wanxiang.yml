# ==================================================================================
# GitHub Actions Workflow: è‡ªåŠ¨åŒæ­¥ amzxyz/rime_wanxiang æœ€æ–°ç‰ˆæœ¬
#
# åŠŸèƒ½:
# 1. å®šæ—¶/æ‰‹åŠ¨è§¦å‘ã€‚
# 2. æ™ºèƒ½æŸ¥æ‰¾å¹¶ä¸‹è½½æœ€æ–°çš„æœ‰æ•ˆ Releaseã€‚
# 3. å¼ºåˆ¶åŒæ­¥æ–‡ä»¶ï¼Œå¹¶æ’é™¤ä¸ªäººé…ç½®ã€‚
# 4. æ¸…ç†æ—§é…ç½®ï¼Œå¹¶ä» custom ç›®å½•å¤åˆ¶æ–°é…ç½®ã€‚
# 5. è‹¥æœ‰å˜æ›´ï¼Œåˆ™è‡ªåŠ¨æäº¤ã€æ¨é€å¹¶åˆ›å»ºæ–°çš„å‘è¡Œç‰ˆã€‚
# ==================================================================================

name: è‡ªåŠ¨åŒæ­¥ Rime ä¸‡è±¡æ–¹æ¡ˆ

on:
  schedule:
    # UTC 19:20 (æ¯éš”ä¸€å¤©) -> åŒ—äº¬æ—¶é—´ 3:20
    - cron: '20 19 */2 * *'

  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # è¯»å†™æƒé™ï¼Œç”¨äºæäº¤ä»£ç å’Œåˆ›å»º Release

    steps:
      - name: ğŸšš æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: 'main'

      - name: ğŸ” æŸ¥æ‰¾æœ€æ–°æœ‰æ•ˆç‰ˆæœ¬
        id: get_release
        run: |
          echo "ğŸ”„ æ­£åœ¨æŸ¥æ‰¾ amzxyz/rime_wanxiang çš„æœ€æ–°æœ‰æ•ˆç‰ˆæœ¬..."
          API_URL="https://api.github.com/repos/amzxyz/rime_wanxiang/releases"
          RELEASES_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github.v3+json" "$API_URL?per_page=30")

          # ç­›é€‰å‡ºèµ„äº§ä¸­åŒ…å« "rime-wanxiang-base.zip" çš„æœ€æ–° Release
          TARGET_RELEASE=$(echo "$RELEASES_INFO" | jq -c '[.[] | select(.assets | map(.name) | contains(["rime-wanxiang-base.zip"]))][0]')

          if [ -z "$TARGET_RELEASE" ] || [ "$TARGET_RELEASE" == "null" ]; then
            echo "â—ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒ…å« 'rime-wanxiang-base.zip' çš„æœ‰æ•ˆç‰ˆæœ¬ã€‚"
            exit 1
          fi

          RELEASE_VERSION=$(echo "$TARGET_RELEASE" | jq -r .tag_name)
          DOWNLOAD_URL=$(echo "$TARGET_RELEASE" | jq -r '.assets[] | select(.name == "rime-wanxiang-base.zip") | .browser_download_url')

          echo "âœ… æˆåŠŸæ‰¾åˆ°ç›®æ ‡ç‰ˆæœ¬: ${RELEASE_VERSION}"
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "download_url=${DOWNLOAD_URL}" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½å¹¶è§£å‹
        run: |
          echo "â³ æ­£åœ¨ä¸‹è½½ Release æ–‡ä»¶..."
          TEMP_DIR="/tmp/rime_sync"
          mkdir -p ${TEMP_DIR}/source
          curl -L "${{ steps.get_release.outputs.download_url }}" -o "${TEMP_DIR}/rime-wanxiang-base.zip"

          echo "ğŸ“¦ æ­£åœ¨è§£å‹æ–‡ä»¶..."
          unzip -q "${TEMP_DIR}/rime-wanxiang-base.zip" -d "${TEMP_DIR}/source/"
          echo "âœ… è§£å‹æˆåŠŸã€‚"

      - name: ğŸ”„ åŒæ­¥æ–‡ä»¶
        run: |
          echo "â³ æ­£åœ¨åŒæ­¥æ–‡ä»¶è‡³ä»“åº“..."
          SOURCE_DIR="/tmp/rime_sync/source"

          # -a: å½’æ¡£æ¨¡å¼, -v: æ˜¾ç¤ºè¯¦æƒ…, --delete: åˆ é™¤å¤šä½™æ–‡ä»¶, --exclude: æ’é™¤é¡¹
          rsync -av --delete \
            --exclude 'bin/' \
            --exclude 'custom/' \
            --exclude '.gitignore' \
            --exclude 'README.md' \
            --exclude 'custom_phrase.txt' \
            --exclude 'ç®€çº¯.trime.yaml' \
            --exclude 'lua/input_stats.lua' \
            --exclude '.git/' \
            --exclude '.github/' \
            "${SOURCE_DIR}/" "./"
          echo "âœ… åŒæ­¥å®Œæˆã€‚"

      - name: ğŸ“ æ¸…ç†å¹¶å¤åˆ¶ä¸ªäººé…ç½®
        run: |
          echo "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç†æ ¹ç›®å½•çš„æ—§é…ç½®æ–‡ä»¶..."
          # -maxdepth 1: ä»…é™æ ¹ç›®å½•, -name: åŒ¹é…æ–‡ä»¶å, -delete: åˆ é™¤
          find . -maxdepth 1 -type f -name "*custom.yaml" -delete

          echo "ğŸ“‚ æ­£åœ¨ä» 'custom' ç›®å½•å¤åˆ¶æ–°é…ç½®..."
          if [ ! -d "custom" ]; then
            echo "âš ï¸ 'custom' ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶ã€‚"
            exit 0
          fi
          # -v: æ˜¾ç¤ºè¯¦æƒ…, -f: å¼ºåˆ¶è¦†ç›–
          find custom -type f -name "*.yaml" -exec cp -vf {} ./ \;
          echo "âœ… é…ç½®å¤„ç†å®Œæˆã€‚"

      - name: âœ¨ æäº¤å¹¶å‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”§ é…ç½® Git ç”¨æˆ·..."
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          if [[ -z $(git status --porcelain) ]]; then
            echo "ğŸ‘ æ–‡ä»¶å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥ã€‚"
            exit 0
          fi

          echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
          git add -A
          COMMIT_MSG="chore(è‡ªåŠ¨åŒæ­¥): åŒæ­¥ amzxyz/rime_wanxiang è‡³ ${{ steps.get_release.outputs.release_version }}"
          git commit -m "${COMMIT_MSG}"

          echo "ğŸš€ æ­£åœ¨æ¨é€è‡³ main åˆ†æ”¯..."
          git push --force
          echo "ğŸ‰ æ¨é€æˆåŠŸï¼Œå‡†å¤‡åˆ›å»º Release..."

          # æ ¼å¼: v25.07.26
          NEW_TAG=$(date +v%y.%m.%d)
          echo "ğŸ·ï¸  ç”Ÿæˆæ–°æ ‡ç­¾: ${NEW_TAG}"

          # æ‰“åŒ…ä¸º rime.zip, æ’é™¤ .git ç›®å½•
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…ä»“åº“æ–‡ä»¶ä¸º rime.zip..."
          zip -qr rime.zip . -x ".git/*"

          # ä½¿ç”¨ GitHub CLI åˆ›å»º Release
          echo "ğŸš€ æ­£åœ¨åˆ›å»º GitHub Release..."
          gh release create "$NEW_TAG" \
            ./rime.zip \
            --title "è‡ªåŠ¨åŒæ­¥å‘è¡Œç‰ˆ ${NEW_TAG}" \
            --notes "æœ¬æ¬¡æ›´æ–°è‡ªåŠ¨åŒæ­¥è‡ª amzxyz/rime_wanxiang çš„ç‰ˆæœ¬: **${{ steps.get_release.outputs.release_version }}**"

          echo "âœ… æ–°å‘è¡Œç‰ˆ ${NEW_TAG} åˆ›å»ºæˆåŠŸï¼"
