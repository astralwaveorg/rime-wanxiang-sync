# GitHub Actions: è‡ªåŠ¨åŒæ­¥ Rime ä¸‡è±¡æ–¹æ¡ˆå¹¶é›†æˆä¸ªäººé…ç½®

name: Atomic Sync

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤©å‡Œæ™¨ 4:45 è¿è¡Œ
    - cron: '45 20 * * *'

  push:
    branches:
      - main

  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸšš æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æŸ¥æ‰¾æœ€æ–°æœ‰æ•ˆç‰ˆæœ¬
        id: get_release
        run: |
          echo "ğŸ”„ æ­£åœ¨æŸ¥æ‰¾ amzxyz/rime_wanxiang çš„æœ€æ–°æœ‰æ•ˆç‰ˆæœ¬..."
          API_URL="https://api.github.com/repos/amzxyz/rime_wanxiang/releases"
          RELEASES_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$API_URL?per_page=30")
          # ç­›é€‰å‡ºèµ„äº§ä¸­åŒ…å« "rime-wanxiang-base.zip" çš„æœ€æ–° Release
          TARGET_RELEASE=$(echo "$RELEASES_INFO" | jq -c '[.[] | select(.assets | map(.name) | contains(["rime-wanxiang-base.zip"]))][0]')

          if [ -z "$TARGET_RELEASE" ] || [ "$TARGET_RELEASE" == "null" ]; then
            echo "â—ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒ…å« 'rime-wanxiang-base.zip' çš„æœ‰æ•ˆç‰ˆæœ¬ã€‚"
            exit 1
          fi

          RELEASE_VERSION=$(echo "$TARGET_RELEASE" | jq -r .tag_name)
          DOWNLOAD_URL=$(echo "$TARGET_RELEASE" | jq -r '.assets[] | select(.name == "rime-wanxiang-base.zip") | .browser_download_url')

          echo "âœ… æˆåŠŸæ‰¾åˆ°ç›®æ ‡ç‰ˆæœ¬: ${RELEASE_VERSION}"
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "download_url=${DOWNLOAD_URL}" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½å¹¶è§£å‹ä¸Šæ¸¸æ–¹æ¡ˆ
        run: |
          TEMP_DIR="/tmp/rime_sync"
          mkdir -p ${TEMP_DIR}/source

          echo "â³ æ­£åœ¨ä¸‹è½½ Release æ–‡ä»¶..."
          curl -L "${{ steps.get_release.outputs.download_url }}" -o "${TEMP_DIR}/rime-wanxiang-base.zip"

          echo "ğŸ“¦ æ­£åœ¨è§£å‹æ–‡ä»¶..."
          unzip -qo "${TEMP_DIR}/rime-wanxiang-base.zip" -d "${TEMP_DIR}/source/"
          echo "âœ… è§£å‹æˆåŠŸã€‚"

      - name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸æ–‡ä»¶
        run: |
          SOURCE_DIR="/tmp/rime_sync/source"

          echo "â³ æ­£åœ¨åŒæ­¥æ–‡ä»¶è‡³ä»“åº“ï¼Œå¹¶æ’é™¤æŒ‡å®šæ–‡ä»¶å’Œç›®å½•..."
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'custom/' \
            --exclude 'bin/' \
            --exclude 'custom_phrase.txt' \
            --exclude 'README.md' \
            --exclude '.gitignore' \
            --exclude 'ç®€çº¯.trime.yaml' \
            --exclude 'wanxiang_reverse.schema.yaml' \
            --exclude 'wanxiang_reverse.dict.yaml' \
            "${SOURCE_DIR}/" "./"
          echo "âœ… ä¸Šæ¸¸æ–‡ä»¶åŒæ­¥å®Œæˆã€‚"

      - name: ğŸ“‚ å¤åˆ¶ä¸ªäººé…ç½®
        run: |
          echo "ğŸ“‚ æ­£åœ¨ä» 'custom' ç›®å½•å®Œæ•´å¤åˆ¶ä¸ªäººé…ç½®..."
          if [ -d "custom" ]; then
            cp -a custom/. ./
            echo "âœ… ä¸ªäººé…ç½®å¤åˆ¶å®Œæˆã€‚"
          else
            echo "âš ï¸ 'custom' ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶ã€‚"
          fi

      - name: âœ¨ æäº¤å¹¶å‘å¸ƒæ–°ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Shanghai
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [[ -z $(git status --porcelain) ]]; then
            echo "ğŸ‘ æ–‡ä»¶å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ“ä½œã€‚"
            exit 0
          fi

          echo "ğŸ“ æ£€æµ‹åˆ°å˜æ›´ï¼Œæ­£åœ¨æäº¤..."
          git add -A
          COMMIT_MSG="chore: åŒæ­¥ amzxyz/rime_wanxiang v${{ steps.get_release.outputs.release_version }}"
          git commit -m "${COMMIT_MSG}"

          echo "ğŸš€ æ­£åœ¨æ¨é€è‡³ main åˆ†æ”¯..."
          git push --force

          # ç‰ˆæœ¬å·æ ¼å¼ï¼švå¹´æœˆ.æ—¥-æ—¶åˆ† (åŒ—äº¬æ—¶é—´)ï¼Œä¾‹å¦‚ v25.07.27-1530
          NEW_TAG=$(date +v%y.%m.%d-%H%M)
          echo "ğŸ·ï¸  ç”Ÿæˆæ–°æ ‡ç­¾ (åŒ—äº¬æ—¶é—´): ${NEW_TAG}"

          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ… Release (å·²è¿‡æ»¤æŒ‡å®šæ–‡ä»¶)..."
          zip -qr rime.zip . -x ".git/*" -x "custom/*" -x "README.md" -x ".gitignore" -x "CHANGELOG.md"

          echo "ğŸš€ æ­£åœ¨åˆ›å»º GitHub Release..."
          gh release create "$NEW_TAG" \
            ./rime.zip \
            --title "è‡ªåŠ¨åŒæ­¥å‘è¡Œç‰ˆ ${NEW_TAG}" \
            --notes "æœ¬æ¬¡æ›´æ–°è‡ªåŠ¨åŒæ­¥è‡ª amzxyz/rime_wanxiang çš„ç‰ˆæœ¬: **${{ steps.get_release.outputs.release_version }}**"

          echo "âœ… æ–°å‘è¡Œç‰ˆ ${NEW_TAG} åˆ›å»ºæˆåŠŸï¼"
