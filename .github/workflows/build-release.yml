# GitHub Actions: æ‰‹åŠ¨æ‰“åŒ…å¹¶å‘å¸ƒ Rime ä¸‡è±¡å‘è¡Œç‰ˆ

name: Manual Release

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸšš æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ æ‰“åŒ…å¹¶åˆ›å»ºåŒç‰ˆæœ¬ Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Shanghai
        run: |
          echo "ğŸ’¡ å·¥ä½œæµå·²æ‰‹åŠ¨è§¦å‘ï¼Œæ­£åœ¨å‡†å¤‡æ‰“åŒ…..."

          NEW_TAG=$(date +v%y.%m.%d-%H%M)
          echo "ğŸ·ï¸  ç”Ÿæˆæ–°æ ‡ç­¾ (åŒ—äº¬æ—¶é—´): ${NEW_TAG}"

          BUILD_DIR="/tmp/release_build"
          mkdir -p "$BUILD_DIR"

          echo "ğŸ“‚ æ­£åœ¨å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•..."
          rsync -av \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'custom' \
            --exclude '.gitignore' \
            --exclude 'README.md' \
            --exclude 'CHANGELOG.md' \
            . "$BUILD_DIR"

          echo "ğŸ“‚ æ­£åœ¨å°†ä¸ªäººé…ç½®å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•çš„æ ¹éƒ¨..."
          if [ -d "custom" ]; then
            cp -a custom/. "$BUILD_DIR"/
            echo "âœ… ä¸ªäººé…ç½®å·²å¤åˆ¶åˆ°æ„å»ºç›®å½•ã€‚"
          else
            echo "âš ï¸ 'custom' ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶ã€‚"
          fi

          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…æ ‡å‡†ç‰ˆ Release (rime.zip)..."
          zip -9qr rime.zip "$BUILD_DIR"/
          echo "âœ… æ ‡å‡†ç‰ˆ rime.zip æ‰“åŒ…å®Œæˆã€‚"

          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…å®Œæ•´ç‰ˆ Release (rime-full.tar.gz)..."
          echo "â³ æ­£åœ¨ä¸‹è½½é¢å¤–æ–‡ä»¶ï¼šwanxiang-lts-zh-hans.gram..."
          curl -L "https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram" -o "$BUILD_DIR"/wanxiang-lts-zh-hans.gram
          echo "âœ… ä¸‹è½½å®Œæˆã€‚"

          tar -czvf rime-full.tar.gz -C "$BUILD_DIR" .
          echo "âœ… å®Œæ•´ç‰ˆ rime-full.tar.gz æ‰“åŒ…å®Œæˆã€‚"

          echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸´æ—¶ç›®å½•..."
          rm -rf "$BUILD_DIR"
          echo "âœ… æ¸…ç†å®Œæˆã€‚"

          echo "ğŸš€ æ­£åœ¨åˆ›å»º GitHub Release å¹¶ä¸Šä¼ åŒç‰ˆæœ¬..."
          NOTES="è¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨åˆ›å»ºçš„å‘è¡Œç‰ˆï¼ŒåŒ…å«ä¸¤ä¸ªå‹ç¼©åŒ…ï¼š\n\n- **rime.zip**: æ ‡å‡†ç‰ˆï¼Œå…¼å®¹æ€§é«˜ï¼Œä»…åŒ…å«åŸºç¡€æ–¹æ¡ˆå’Œä¸ªäººé…ç½®ã€‚\n- **rime-full.tar.gz**: å®Œæ•´ç‰ˆï¼Œå‹ç¼©ç‡æ›´é«˜ï¼Œé¢å¤–é›†æˆäº† **wanxiang-lts-zh-hans.gram** å¤§è¯åº“ã€‚"

          gh release create "$NEW_TAG" \
            ./rime.zip \
            ./rime-full.tar.gz \
            --title "æ‰‹åŠ¨æ‰“åŒ…å‘è¡Œç‰ˆ ${NEW_TAG}" \
            --notes "$NOTES"

          echo "âœ… æ–°å‘è¡Œç‰ˆ ${NEW_TAG} åˆ›å»ºæˆåŠŸï¼"

          echo "ğŸ§¹ æ­£åœ¨æ¸…ç†æœ¬åœ°æ‰“åŒ…æ–‡ä»¶..."
          rm -f rime.zip rime-full.tar.gz
          echo "âœ… æœ¬åœ°æ–‡ä»¶å·²æ¸…ç†ã€‚"
