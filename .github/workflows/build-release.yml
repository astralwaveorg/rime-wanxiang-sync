# GitHub Actions: æ‰‹åŠ¨æ‰“åŒ…å¹¶å‘å¸ƒ Rime ä¸‡è±¡å‘è¡Œç‰ˆ

name: Manual Release

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸšš æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ æ‰“åŒ…å¹¶åˆ›å»ºåŒç‰ˆæœ¬ Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Shanghai
        run: |
          echo "ğŸ’¡ å·¥ä½œæµå·²æ‰‹åŠ¨è§¦å‘ï¼Œæ­£åœ¨å‡†å¤‡æ‰“åŒ…..."

          # ç‰ˆæœ¬å·æ ¼å¼ï¼švå¹´æœˆ.æ—¥-æ—¶åˆ† (åŒ—äº¬æ—¶é—´)
          NEW_TAG=$(date +v%y.%m.%d-%H%M)
          echo "ğŸ·ï¸  ç”Ÿæˆæ–°æ ‡ç­¾ (åŒ—äº¬æ—¶é—´): ${NEW_TAG}"

          # --- æ‰“åŒ… rime.zip ---
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…æ ‡å‡†ç‰ˆ Release (rime.zip)..."

          # ä¸´æ—¶å¤åˆ¶ä¸ªäººé…ç½®ï¼Œä»¥ä¾¿æ‰“åŒ…æ—¶åŒ…å«
          if [ -d "custom" ]; then
            cp -a custom/. ./
            echo "âœ… ä¸ªäººé…ç½®å·²ä¸´æ—¶å¤åˆ¶åˆ°æ ¹ç›®å½•ã€‚"
          else
            echo "âš ï¸ 'custom' ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åªæ‰“åŒ…ä¸Šæ¸¸æ–‡ä»¶ã€‚"
          fi

          # æ‰“åŒ…æ ‡å‡†ç‰ˆï¼Œä¸åŒ…å« wanxiang-lts-zh-hans.gram æ–‡ä»¶
          zip -qr rime.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "custom/*" \
            -x "README.md" \
            -x ".gitignore" \
            -x "CHANGELOG.md"

          echo "âœ… æ ‡å‡†ç‰ˆ rime.zip æ‰“åŒ…å®Œæˆã€‚"

          # --- æ‰“åŒ… rime-full.zip ---
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…å®Œæ•´ç‰ˆ Release (rime-full.zip)..."

          echo "â³ æ­£åœ¨ä¸‹è½½é¢å¤–æ–‡ä»¶ï¼šwanxiang-lts-zh-hans.gram..."
          curl -L "https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram" -o wanxiang-lts-zh-hans.gram
          echo "âœ… ä¸‹è½½å®Œæˆã€‚"

          zip -qr rime-full.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "custom/*" \
            -x "README.md" \
            -x ".gitignore" \
            -x "CHANGELOG.md"
          echo "âœ… å®Œæ•´ç‰ˆ rime-full.zip æ‰“åŒ…å®Œæˆã€‚"

          # --- æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ---
          echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          if [ -d "custom" ]; then
              find custom -type f -exec basename {} \; | xargs -I {} rm -f "{}"
          fi
          rm -f wanxiang-lts-zh-hans.gram
          echo "âœ… æ¸…ç†å®Œæˆã€‚"

          # --- åˆ›å»º Release å¹¶ä¸Šä¼ ä¸¤ä¸ªå‹ç¼©åŒ… ---
          echo "ğŸš€ æ­£åœ¨åˆ›å»º GitHub Release å¹¶ä¸Šä¼ åŒç‰ˆæœ¬..."
          gh release create "$NEW_TAG" \
            ./rime.zip \
            ./rime-full.zip \
            --title "æ‰‹åŠ¨æ‰“åŒ…å‘è¡Œç‰ˆ ${NEW_TAG}" \
            --notes "è¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨åˆ›å»ºçš„å‘è¡Œç‰ˆï¼ŒåŒ…å«ä¸¤ä¸ªå‹ç¼©åŒ…ï¼šâ‘  **rime.zip**: æ ‡å‡†ç‰ˆï¼Œä»…åŒ…å«åŸºç¡€æ–¹æ¡ˆå’Œä¸ªäººé…ç½®ã€‚â‘¡ **rime-full.zip**: å®Œæ•´ç‰ˆï¼Œé¢å¤–é›†æˆäº† **wanxiang-lts-zh-hans.gram** å¤§è¯åº“ã€‚"

          echo "âœ… æ–°å‘è¡Œç‰ˆ ${NEW_TAG} åˆ›å»ºæˆåŠŸï¼"
