# GitHub Actions: æ‰‹åŠ¨æ‰“åŒ…å¹¶å‘å¸ƒ Rime ä¸‡è±¡å‘è¡Œç‰ˆ

name: Manual Release

on:
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸšš æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ æ‰“åŒ…å¹¶åˆ›å»ºåŒç‰ˆæœ¬ Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Asia/Shanghai
        run: |
          echo "ğŸ’¡ å·¥ä½œæµå·²æ‰‹åŠ¨è§¦å‘ï¼Œæ­£åœ¨å‡†å¤‡æ‰“åŒ…..."

          # ç‰ˆæœ¬å·æ ¼å¼ï¼švå¹´æœˆ.æ—¥-æ—¶åˆ† (åŒ—äº¬æ—¶é—´)
          NEW_TAG=$(date +v%y.%m.%d-%H%M)
          echo "ğŸ·ï¸  ç”Ÿæˆæ–°æ ‡ç­¾ (åŒ—äº¬æ—¶é—´): ${NEW_TAG}"

          # --- 1. æ‰“åŒ…æ ‡å‡†ç‰ˆ rime.zip ---
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…æ ‡å‡†ç‰ˆ Release (rime.zip)..."

          if [ -d "custom" ]; then
            cp -a custom/. ./
            echo "âœ… ä¸ªäººé…ç½®å·²ä¸´æ—¶å¤åˆ¶åˆ°æ ¹ç›®å½•ã€‚"
          else
            echo "âš ï¸ 'custom' ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åªæ‰“åŒ…ä¸Šæ¸¸æ–‡ä»¶ã€‚"
          fi

          # ä½¿ç”¨ zip çš„æœ€é«˜å‹ç¼©ç‡ (-9)
          zip -9qr rime.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "custom/*" \
            -x "README.md" \
            -x ".gitignore" \
            -x "CHANGELOG.md"

          echo "âœ… æ ‡å‡†ç‰ˆ rime.zip æ‰“åŒ…å®Œæˆã€‚"

          # --- 2. æ‰“åŒ…å®Œæ•´ç‰ˆ rime-full.tar.gz ---
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…å®Œæ•´ç‰ˆ Release (rime-full.tar.gz)..."

          echo "â³ æ­£åœ¨ä¸‹è½½é¢å¤–æ–‡ä»¶ï¼šwanxiang-lts-zh-hans.gram..."
          curl -L "https://github.com/amzxyz/RIME-LMDG/releases/download/LTS/wanxiang-lts-zh-hans.gram" -o wanxiang-lts-zh-hans.gram
          echo "âœ… ä¸‹è½½å®Œæˆã€‚"

          # ã€æ³¨æ„ã€‘: tar å‘½ä»¤çš„æ’é™¤è¯­æ³•ä¸ zip ä¸åŒ
          # æ­¤å¤–ï¼Œè¿™é‡Œä¼šç›´æ¥å°†æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…ï¼ŒåŒ…æ‹¬ä¹‹å‰åˆ›å»ºçš„ rime.zipï¼Œå› æ­¤éœ€è¦å°†å…¶æ’é™¤
          tar -czvf rime-full.tar.gz \
            --exclude='custom' \
            --exclude='rime.zip' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='README.md' \
            --exclude='CHANGELOG.md' \
            .

          echo "âœ… å®Œæ•´ç‰ˆ rime-full.tar.gz æ‰“åŒ…å®Œæˆã€‚"

          # --- 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ---
          echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          if [ -d "custom" ]; then
              find custom -type f -exec basename {} \; | xargs -I {} rm -f "{}"
          fi
          rm -f wanxiang-lts-zh-hans.gram
          rm -f rime.zip rime-full.tar.gz
          echo "âœ… æ¸…ç†å®Œæˆã€‚"

          # --- 4. åˆ›å»º Release å¹¶ä¸Šä¼ åŒç‰ˆæœ¬ ---
          echo "ğŸš€ æ­£åœ¨åˆ›å»º GitHub Release å¹¶ä¸Šä¼ åŒç‰ˆæœ¬..."
          # gh release create ç›´æ¥åˆ—å‡ºæ‰€æœ‰è¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
          NOTES="è¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨åˆ›å»ºçš„å‘è¡Œç‰ˆï¼ŒåŒ…å«ä¸¤ä¸ªå‹ç¼©åŒ…ï¼š\n\n- **rime.zip**: æ ‡å‡†ç‰ˆï¼Œå…¼å®¹æ€§é«˜ï¼Œä»…åŒ…å«åŸºç¡€æ–¹æ¡ˆå’Œä¸ªäººé…ç½®ã€‚\n- **rime-full.tar.gz**: å®Œæ•´ç‰ˆï¼Œå‹ç¼©ç‡æ›´é«˜ï¼Œé¢å¤–é›†æˆäº† **wanxiang-lts-zh-hans.gram** å¤§è¯åº“ã€‚"
          gh release create "$NEW_TAG" \
            ./rime.zip \
            ./rime-full.tar.gz \
            --title "æ‰‹åŠ¨æ‰“åŒ…å‘è¡Œç‰ˆ ${NEW_TAG}" \
            --notes "${NOTES}"

          echo "âœ… æ–°å‘è¡Œç‰ˆ ${NEW_TAG} åˆ›å»ºæˆåŠŸï¼"
